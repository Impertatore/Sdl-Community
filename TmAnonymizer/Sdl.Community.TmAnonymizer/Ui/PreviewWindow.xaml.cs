using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using MahApps.Metro.Controls.Dialogs;
using Sdl.Community.SdlTmAnonymizer.Model;

namespace Sdl.Community.SdlTmAnonymizer.Ui
{
	/// <summary>
	/// Interaction logic for PreviewWindow.xaml
	/// </summary>
	public partial class PreviewWindow
	{
		public  IDialogCoordinator DialogCoordinatorWindow;
		private RichTextBox _textBox;
		public PreviewWindow()
		{
			InitializeComponent();
			DialogCoordinatorWindow =DialogCoordinator.Instance;
		}

		private void FrameworkElement_OnContextMenuOpening(object sender, ContextMenuEventArgs e)
		{
			var rtb = sender as RichTextBox;
			_textBox = rtb;
		}

		private void MenuItem_OnClick(object sender, RoutedEventArgs e)
		{
			var docStart = _textBox.Document.ContentStart;
			var start = _textBox.Selection.Start;
			var end = _textBox.Selection.End;

			var parent = (RichTextBox)_textBox.Document.Parent;
			var tag = string.Empty;
			if (parent != null)
			{
				tag = (string)parent.Tag;
			}

			var tr = new TextRange(start, end);
			tr.ApplyPropertyValue(TextElement.BackgroundProperty, Brushes.LightSalmon);

			var dataContext = _textBox.DataContext as SourceSearchResult;
			var startRange = new TextRange(docStart, start);
			var indexStartAbs = startRange.Text.Length;
			var text = new TextRange(docStart, _textBox.Document.ContentEnd).Text.TrimEnd();
			var wordDetails = new WordDetails
			{
				Position = indexStartAbs,
				Length = indexStartAbs+_textBox.Selection.Text.TrimEnd().Length, 
				Text = _textBox.Selection.Text.TrimEnd()
				
			};
			var nextWord = GetNextWord(wordDetails, text);
			wordDetails.NextWord = nextWord;
			if (tag.Equals("SourceBox"))
			{
				dataContext?.SelectedWordsDetails.Add(wordDetails);
			}
			else
			{
				dataContext?.TargetSelectedWordsDetails.Add(wordDetails);
			}
			
		}
			
		private string GetNextWord(WordDetails wordDetails,string text)
		{
			var splitedWord = text.Substring(wordDetails.Length+1);
			if (!string.IsNullOrEmpty(splitedWord))
			{
				return splitedWord.Substring(0, splitedWord.IndexOf(" ", StringComparison.Ordinal));
			}
			//that means selected word is the last one
			return string.Empty;
		}
		private void UnselectWord(object sender, RoutedEventArgs e)
		{
			var docStart = _textBox.Document.ContentStart;
			var start = _textBox.Selection.Start;
			var end = _textBox.Selection.End;

			var parent = (RichTextBox)_textBox.Document.Parent;
			var tag = string.Empty;
			if (parent != null)
			{
				tag = (string)parent.Tag;
			}
			var tr = new TextRange(start, end);
			tr.ApplyPropertyValue(TextElement.BackgroundProperty, Brushes.White);
			var dataContext = _textBox.DataContext as SourceSearchResult;

			var startRange = new TextRange(docStart, start);
			var indexStartAbs = startRange.Text.Length;
			var text = new TextRange(docStart, _textBox.Document.ContentEnd).Text.TrimEnd();

			var wordDetails = new WordDetails
			{
				Position = indexStartAbs,
				Length = indexStartAbs + _textBox.Selection.Text.TrimEnd().Length,
				Text = _textBox.Selection.Text.TrimEnd()
			};
			var prevWord = GetPreviosWord(wordDetails, text);
			wordDetails.PreviousWord = prevWord;
			if (tag.Equals("SourceBox"))
			{
				dataContext?.DeSelectedWordsDetails.Add(wordDetails);
			}
			else
			{
				dataContext?.TargetDeSelectedWordsDetails.Add(wordDetails);
			}
		}

		private string GetPreviosWord(WordDetails wordDetails, string text)
		{
			//if is first word we don't have prev word
			if (wordDetails.Position.Equals(0))
			{
				return string.Empty;
			}
			var firstPartOfString = text.Substring(0, wordDetails.Position).TrimEnd();
			var lastIndexOfSpace = firstPartOfString.LastIndexOf(" ", StringComparison.Ordinal);
			if (lastIndexOfSpace != -1)
			{
				return firstPartOfString.Substring(lastIndexOfSpace);
			}
			//if user deselected only a part from the word
			return string.Empty;
		}
	}
}
